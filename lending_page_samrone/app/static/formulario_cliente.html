<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dados do Cliente - Samarone MÃ³veis</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --rich-black: #101820;
            --vivid-yellow: #FEE715;
            --white: #FFFFFF;
            --light-gray: #F5F5F5;
            --success-green: #28a745;
            --danger-red: #dc3545;
            --warning-orange: #fd7e14;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--rich-black);
            background: linear-gradient(135deg, var(--light-gray) 0%, #e8e8e8 100%);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: var(--rich-black);
            color: var(--white);
            padding: 1rem 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .navbar {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--vivid-yellow);
            text-decoration: none;
        }

        .nav-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn-voltar {
            background: transparent;
            color: var(--white);
            padding: 0.5rem 1rem;
            border: 2px solid var(--white);
            border-radius: 25px;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .btn-voltar:hover {
            background: var(--white);
            color: var(--rich-black);
        }

        /* Progress Steps */
        .progress-container {
            background: var(--white);
            padding: 2rem 0;
            border-bottom: 2px solid var(--light-gray);
        }

        .progress-steps {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
            position: relative;
        }

        .progress-steps::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--light-gray);
            z-index: 1;
        }

        .progress-steps::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            width: 50%;
            height: 2px;
            background: var(--vivid-yellow);
            z-index: 2;
            transition: width 0.3s ease;
        }

        .step {
            background: var(--white);
            border: 3px solid var(--light-gray);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            position: relative;
            z-index: 3;
            transition: all 0.3s ease;
        }

        .step.completed {
            background: var(--success-green);
            border-color: var(--success-green);
            color: var(--white);
        }

        .step.active {
            background: var(--vivid-yellow);
            border-color: var(--vivid-yellow);
            color: var(--rich-black);
            transform: scale(1.1);
        }

        .step-label {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.9rem;
            font-weight: bold;
            color: var(--rich-black);
            white-space: nowrap;
        }

        /* Main Container */
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 3rem 2rem;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 3rem;
        }

        /* FormulÃ¡rio */
        .formulario-container {
            background: var(--white);
            border-radius: 20px;
            padding: 3rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
        }

        .form-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .form-title {
            font-size: 2rem;
            color: var(--rich-black);
            margin-bottom: 0.5rem;
        }

        .form-subtitle {
            color: #666;
            font-size: 1.1rem;
        }

        /* Form Groups */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            font-weight: bold;
            color: var(--rich-black);
            font-size: 1rem;
        }

        .form-label.required::after {
            content: '*';
            color: var(--danger-red);
            margin-left: 5px;
        }

        .form-input {
            padding: 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--white);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--vivid-yellow);
            box-shadow: 0 0 0 3px rgba(254, 231, 21, 0.1);
        }

        .form-input.valid {
            border-color: var(--success-green);
            background: rgba(40, 167, 69, 0.05);
        }

        .form-input.invalid {
            border-color: var(--danger-red);
            background: rgba(220, 53, 69, 0.05);
        }

        /* Input Icons */
        .input-container {
            position: relative;
        }

        .input-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .input-icon.valid {
            color: var(--success-green);
        }

        .input-icon.invalid {
            color: var(--danger-red);
        }

        /* Validation Messages */
        .validation-message {
            font-size: 0.9rem;
            margin-top: 0.3rem;
            transition: all 0.3s ease;
            min-height: 20px;
        }

        .validation-message.error {
            color: var(--danger-red);
        }

        .validation-message.success {
            color: var(--success-green);
        }

        /* EndereÃ§o Section */
        .endereco-section {
            grid-column: 1 / -1;
            margin-top: 1rem;
            padding: 2rem;
            background: var(--light-gray);
            border-radius: 15px;
            border-left: 4px solid var(--vivid-yellow);
        }

        .endereco-title {
            font-size: 1.3rem;
            color: var(--rich-black);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .cep-container {
            position: relative;
        }

        .cep-loading {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1rem;
            color: var(--vivid-yellow);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: translateY(-50%) rotate(0deg); }
            to { transform: translateY(-50%) rotate(360deg); }
        }

        /* Resumo do Pedido */
        .resumo-container {
            background: var(--white);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            height: fit-content;
            position: sticky;
            top: 120px;
            border: 1px solid #e0e0e0;
        }

        .resumo-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--light-gray);
        }

        .resumo-title {
            font-size: 1.5rem;
            color: var(--rich-black);
            margin-bottom: 0.5rem;
        }

        .resumo-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--light-gray);
        }

        .resumo-item:last-child {
            border-bottom: none;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid var(--light-gray);
            font-weight: bold;
        }

        .resumo-label {
            color: #666;
            font-size: 0.95rem;
        }

        .resumo-valor {
            font-weight: bold;
            color: var(--rich-black);
        }

        .total-final {
            font-size: 1.2rem;
            color: var(--vivid-yellow);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        /* Itens do Carrinho */
        .carrinho-items {
            margin-bottom: 2rem;
        }

        .carrinho-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--light-gray);
            border-radius: 10px;
            margin-bottom: 1rem;
        }

        .item-image {
            width: 50px;
            height: 50px;
            background: var(--white);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .item-info {
            flex-grow: 1;
        }

        .item-nome {
            font-weight: bold;
            font-size: 0.9rem;
            color: var(--rich-black);
            margin-bottom: 0.2rem;
        }

        .item-detalhes {
            font-size: 0.8rem;
            color: #666;
        }

        .item-preco {
            font-weight: bold;
            color: var(--rich-black);
            font-size: 0.9rem;
        }

        /* BotÃµes de AÃ§Ã£o */
        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            justify-content: space-between;
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 50px;
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            text-align: center;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            min-width: 200px;
        }

        .btn-primary {
            background: var(--vivid-yellow);
            color: var(--rich-black);
        }

        .btn-primary:hover:not(:disabled) {
            background: #e6d014;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(254, 231, 21, 0.3);
        }

        .btn-primary:disabled {
            background: #ccc;
            color: #666;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: transparent;
            color: var(--rich-black);
            border: 2px solid var(--rich-black);
        }

        .btn-secondary:hover {
            background: var(--rich-black);
            color: var(--white);
        }

        /* Loading State */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        .loading-content {
            background: var(--white);
            padding: 3rem;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--light-gray);
            border-top: 4px solid var(--vivid-yellow);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 120px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.4s ease;
            color: white;
            font-weight: bold;
            min-width: 250px;
            max-width: 400px;
            opacity: 0;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast.success {
            background: var(--success-green);
        }

        .toast.error {
            background: var(--danger-red);
        }

        .toast.warning {
            background: var(--warning-orange);
        }

        /* Responsive para toast */
        @media (max-width: 768px) {
            .toast {
                right: 10px;
                left: 10px;
                top: 100px;
                transform: translateY(-100%);
                min-width: auto;
                max-width: none;
            }

            .toast.show {
                transform: translateY(0);
            }
        }

        /* Responsive */
        @media (max-width: 968px) {
            .container {
                grid-template-columns: 1fr;
                gap: 2rem;
                padding: 2rem 1rem;
            }

            .resumo-container {
                position: relative;
                top: auto;
                order: -1;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .progress-steps {
                padding: 0 1rem;
            }

            .step-label {
                font-size: 0.8rem;
            }
        }

        @media (max-width: 768px) {
            .formulario-container {
                padding: 2rem 1.5rem;
            }

            .navbar {
                padding: 0 1rem;
            }

            .form-title {
                font-size: 1.6rem;
            }

            .btn {
                min-width: auto;
                flex: 1;
            }

            .form-actions {
                flex-direction: column;
            }

            .progress-steps::before,
            .progress-steps::after {
                display: none;
            }

            .step {
                transform: none !important;
            }
        }

        /* AnimaÃ§Ãµes */
        .form-group {
            animation: fadeInUp 0.5s ease-out;
            animation-fill-mode: both;
        }

        .form-group:nth-child(1) { animation-delay: 0.1s; }
        .form-group:nth-child(2) { animation-delay: 0.2s; }
        .form-group:nth-child(3) { animation-delay: 0.3s; }
        .form-group:nth-child(4) { animation-delay: 0.4s; }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Carrinho Vazio */
        .carrinho-vazio {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .carrinho-vazio .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #ccc;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <nav class="navbar">
            <a href="lending_page.html" class="logo">Samarone Móveis</a>
            <div class="nav-actions">
                <a href="carrinho_compras.html" class="btn-voltar">â† Voltar ao Carrinho</a>
            </div>
        </nav>
    </header>

    <!-- Progress Steps -->
    <div class="progress-container">
        <div class="progress-steps">
            <div class="step completed">
                <span>1</span>
                <div class="step-label">Carrinho</div>
            </div>
            <div class="step active">
                <span>2</span>
                <div class="step-label">Dados do Cliente</div>
            </div>
            <div class="step">
                <span>3</span>
                <div class="step-label">Pagamento</div>
            </div>
            <div class="step">
                <span>4</span>
                <div class="step-label">ConfirmaÃ§Ã£o</div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- FormulÃ¡rio -->
        <div class="formulario-container">
            <div class="form-header">
                <h1 class="form-title">ðŸ“‹ Seus Dados</h1>
                <p class="form-subtitle">Preencha suas informaÃ§Ãµes para finalizar o pedido</p>
            </div>

            <form id="formularioCliente" novalidate>
                <!-- Dados Pessoais -->
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="nomeCompleto" class="form-label required">Nome Completo</label>
                        <div class="input-container">
                            <input type="text"
                                   id="nomeCompleto"
                                   name="nomeCompleto"
                                   class="form-input"
                                   placeholder="Digite seu nome completo"
                                   required>
                            <span class="input-icon" id="nomeIcon"></span>
                        </div>
                        <div class="validation-message" id="nomeMessage"></div>
                    </div>

                    <div class="form-group">
                        <label for="telefone" class="form-label required">Telefone/WhatsApp</label>
                        <div class="input-container">
                            <input type="tel"
                                   id="telefone"
                                   name="telefone"
                                   class="form-input"
                                   placeholder="(00) 00000-0000"
                                   required>
                            <span class="input-icon" id="telefoneIcon"></span>
                        </div>
                        <div class="validation-message" id="telefoneMessage"></div>
                    </div>

                    <div class="form-group">
                        <label for="email" class="form-label required">E-mail</label>
                        <div class="input-container">
                            <input type="email"
                                   id="email"
                                   name="email"
                                   class="form-input"
                                   placeholder="seu@email.com"
                                   required>
                            <span class="input-icon" id="emailIcon"></span>
                        </div>
                        <div class="validation-message" id="emailMessage"></div>
                    </div>

                    <div class="form-group">
                        <label for="cpf" class="form-label required">CPF</label>
                        <div class="input-container">
                            <input type="text"
                                   id="cpf"
                                   name="cpf"
                                   class="form-input"
                                   placeholder="000.000.000-00"
                                   required>
                            <span class="input-icon" id="cpfIcon"></span>
                        </div>
                        <div class="validation-message" id="cpfMessage"></div>
                    </div>
                </div>

                <!-- EndereÃ§o -->
                <div class="endereco-section">
                    <h3 class="endereco-title">ðŸ“ EndereÃ§o de Entrega</h3>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="cep" class="form-label required">CEP</label>
                            <div class="input-container cep-container">
                                <input type="text"
                                       id="cep"
                                       name="cep"
                                       class="form-input"
                                       placeholder="00000-000"
                                       required>
                                <span class="input-icon" id="cepIcon"></span>
                                <span class="cep-loading" id="cepLoading" style="display: none;">â³</span>
                            </div>
                            <div class="validation-message" id="cepMessage"></div>
                        </div>

                        <div class="form-group">
                            <label for="estado" class="form-label required">Estado</label>
                            <div class="input-container">
                                <input type="text"
                                       id="estado"
                                       name="estado"
                                       class="form-input"
                                       placeholder="Ex: RJ, SP, MG..."
                                       maxlength="2">
                                <span class="input-icon" id="estadoIcon"></span>
                            </div>
                            <div class="validation-message" id="estadoMessage"></div>
                        </div>

                        <div class="form-group">
                            <label for="cidade" class="form-label required">Cidade</label>
                            <div class="input-container">
                                <input type="text"
                                       id="cidade"
                                       name="cidade"
                                       class="form-input"
                                       placeholder="Digite sua cidade">
                                <span class="input-icon" id="cidadeIcon"></span>
                            </div>
                            <div class="validation-message" id="cidadeMessage"></div>
                        </div>

                        <div class="form-group">
                            <label for="bairro" class="form-label required">Bairro</label>
                            <div class="input-container">
                                <input type="text"
                                       id="bairro"
                                       name="bairro"
                                       class="form-input"
                                       placeholder="Digite seu bairro">
                                <span class="input-icon" id="bairroIcon"></span>
                            </div>
                            <div class="validation-message" id="bairroMessage"></div>
                        </div>

                        <div class="form-group">
                            <label for="rua" class="form-label required">Rua</label>
                            <div class="input-container">
                                <input type="text"
                                       id="rua"
                                       name="rua"
                                       class="form-input"
                                       placeholder="Digite o nome da rua">
                                <span class="input-icon" id="ruaIcon"></span>
                            </div>
                            <div class="validation-message" id="ruaMessage"></div>
                        </div>

                        <div class="form-group">
                            <label for="numero" class="form-label required">NÃºmero</label>
                            <div class="input-container">
                                <input type="text"
                                       id="numero"
                                       name="numero"
                                       class="form-input"
                                       placeholder="123">
                                <span class="input-icon" id="numeroIcon"></span>
                            </div>
                            <div class="validation-message" id="numeroMessage"></div>
                        </div>

                        <div class="form-group full-width">
                            <label for="complemento" class="form-label">Complemento</label>
                            <div class="input-container">
                                <input type="text"
                                       id="complemento"
                                       name="complemento"
                                       class="form-input"
                                       placeholder="Apartamento, bloco, referÃªncia... (opcional)">
                                <span class="input-icon" id="complementoIcon"></span>
                            </div>
                            <div class="validation-message" id="complementoMessage"></div>
                        </div>
                    </div>
                </div>

                <!-- BotÃµes de AÃ§Ã£o -->
                <div class="form-actions">
                    <a href="carrinho_compras.html" class="btn btn-secondary">
                        â† Voltar ao Carrinho
                    </a>
                    <button type="submit" class="btn btn-primary" id="btnFinalizar" disabled>
                        <span id="btnTexto">Finalizar Pedido</span>
                        <span id="btnLoading" style="display: none;">â³ Processando...</span>
                    </button>
                </div>
            </form>
        </div>

        <!-- Resumo do Pedido -->
        <div class="resumo-container">
            <div class="resumo-header">
                <h3 class="resumo-title">ðŸ“¦ Resumo do Pedido</h3>
            </div>

            <!-- Itens do Carrinho -->
            <div class="carrinho-items" id="carrinhoItems">
                <div class="carrinho-vazio" id="carrinhoVazio">
                    <div class="icon">ðŸ›’</div>
                    <p>Carrinho vazio</p>
                </div>
            </div>

            <!-- Resumo Financeiro -->
            <div class="resumo-item">
                <span class="resumo-label">Subtotal:</span>
                <span class="resumo-valor" id="subtotal">R$ 0,00</span>
            </div>

            <div class="resumo-item">
                <span class="resumo-label">Taxa de Entrega:</span>
                <span class="resumo-valor" id="taxaEntrega">A calcular</span>
            </div>

            <div class="resumo-item">
                <span class="resumo-label">Desconto:</span>
                <span class="resumo-valor" id="desconto">R$ 0,00</span>
            </div>

            <div class="resumo-item">
                <span class="resumo-label">Total:</span>
                <span class="resumo-valor total-final" id="total">R$ 0,00</span>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3>Processando seus dados...</h3>
            <p>Aguarde enquanto criamos seu pedido</p>
        </div>
    </div>

    <!-- Toast para notificaÃ§Ãµes -->
    <div id="toast" class="toast"></div>

    <script>

        const API_BASE = window.location.hostname === 'localhost' ||
                 window.location.hostname === '127.0.0.1'
                 ? 'http://localhost:8000'
                 : window.location.origin;

        // ðŸ”§ VARIÃVEIS GLOBAIS
        let dadosCheckout = null;
        let formularioValido = false;
        let validacaoEmAndamento = false;

        // ðŸš€ INICIALIZAÃ‡ÃƒO
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸ“‹ Inicializando formulÃ¡rio do cliente...');

            carregarDadosCheckout();
            configurarMascaras();
            configurarValidacoes();
            configurarFormulario();
        });

        // ðŸ“¦ CARREGAR DADOS DO CHECKOUT
        function carregarDadosCheckout() {
            try {
                // Carregar dados do sessionStorage (vindos do carrinho)
                const checkoutData = sessionStorage.getItem('carrinho_checkout');

                if (checkoutData) {
                    dadosCheckout = JSON.parse(checkoutData);
                    console.log('âœ… Dados do checkout carregados:', dadosCheckout);
                    renderizarResumo();
                } else {
                    // Fallback: tentar carregar do localStorage
                    const carrinhoLocal = localStorage.getItem('carrinho_samarone');
                    if (carrinhoLocal) {
                        const itens = JSON.parse(carrinhoLocal);
                        dadosCheckout = {
                            itens: itens,
                            subtotal: calcularSubtotal(itens),
                            taxa_entrega: 0,
                            total: calcularSubtotal(itens),
                            timestamp: new Date().toISOString()
                        };
                        console.log('âš ï¸ Usando dados do localStorage como fallback');
                        renderizarResumo();
                    } else {
                        console.log('âŒ Nenhum dado de checkout encontrado');
                        mostrarCarrinhoVazio();
                    }
                }

            } catch (error) {
                console.error('âŒ Erro ao carregar dados do checkout:', error);
                mostrarToast('Erro ao carregar dados do carrinho', 'error');
                mostrarCarrinhoVazio();
            }
        }

        function calcularSubtotal(itens) {
            return itens.reduce((total, item) => total + (item.preco_unitario * item.quantidade), 0);
        }

        function renderizarResumo() {
            const container = document.getElementById('carrinhoItems');
            const carrinhoVazio = document.getElementById('carrinhoVazio');

            if (!dadosCheckout || !dadosCheckout.itens || dadosCheckout.itens.length === 0) {
                mostrarCarrinhoVazio();
                return;
            }

            carrinhoVazio.style.display = 'none';
            container.innerHTML = '';

            // Renderizar itens
            dadosCheckout.itens.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'carrinho-item';

                const subtotalItem = item.preco_unitario * item.quantidade;

                itemElement.innerHTML = `
                    <div class="item-info">
                        <div class="item-nome">${item.nome}</div>
                        <div class="item-detalhes">${item.quantidade}x - ${item.materiais}</div>
                    </div>
                    <div class="item-preco">R$ ${subtotalItem.toFixed(2).replace('.', ',')}</div>
                `;

                container.appendChild(itemElement);
            });

            // Atualizar valores
            document.getElementById('subtotal').textContent = formatarPreco(dadosCheckout.subtotal);
            document.getElementById('taxaEntrega').textContent = dadosCheckout.taxa_entrega > 0 ? formatarPreco(dadosCheckout.taxa_entrega) : 'GrÃ¡tis';
            document.getElementById('desconto').textContent = formatarPreco(0);
            document.getElementById('total').textContent = formatarPreco(dadosCheckout.total);
        }

        function mostrarCarrinhoVazio() {
            document.getElementById('carrinhoVazio').style.display = 'block';
            document.getElementById('btnFinalizar').disabled = true;
            mostrarToast('Carrinho vazio! Adicione itens primeiro.', 'warning');
        }


        function formatarPreco(valor) {
            return `R$ ${valor.toFixed(2).replace('.', ',')}`;
        }

        // ðŸŽ­ CONFIGURAR MÃSCARAS
        function configurarMascaras() {
            // MÃ¡scara para telefone
            const telefoneInput = document.getElementById('telefone');
            telefoneInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length <= 11) {
                    if (value.length <= 10) {
                        // Formato: (00) 0000-0000
                        value = value.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
                    } else {
                        // Formato: (00) 00000-0000
                        value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
                    }
                }
                e.target.value = value;
            });

            // MÃ¡scara para CPF
            const cpfInput = document.getElementById('cpf');
            cpfInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length <= 11) {
                    value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
                }
                e.target.value = value;
            });

            // MÃ¡scara para CEP
            const cepInput = document.getElementById('cep');
            cepInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length <= 8) {
                    value = value.replace(/(\d{5})(\d{3})/, '$1-$2');
                }
                e.target.value = value;
            });
        }

        // âœ… CONFIGURAR VALIDAÃ‡Ã•ES
        function configurarValidacoes() {
            const campos = [
                { id: 'nomeCompleto', validador: validarNome },
                { id: 'telefone', validador: validarTelefone },
                { id: 'email', validador: validarEmail },
                { id: 'cpf', validador: validarCPF },
                { id: 'cep', validador: validarCEP },
                { id: 'estado', validador: validarEstado },
                { id: 'cidade', validador: validarCidade },
                { id: 'bairro', validador: validarBairro },
                { id: 'rua', validador: validarRua },
                { id: 'numero', validador: validarNumero }
            ];

            campos.forEach(campo => {
                const input = document.getElementById(campo.id);

                // ValidaÃ§Ã£o em tempo real
                input.addEventListener('input', function() {
                    clearTimeout(input.validationTimeout);
                    input.validationTimeout = setTimeout(() => {
                        campo.validador(input);
                        verificarFormularioCompleto();
                    }, 500);
                });

                // ValidaÃ§Ã£o ao sair do campo
                input.addEventListener('blur', function() {
                    campo.validador(input);
                    verificarFormularioCompleto();
                });
            });

            // CEP com busca automÃ¡tica
            const cepInput = document.getElementById('cep');
            cepInput.addEventListener('blur', buscarCEP);
        }

        // ðŸ” FUNÃ‡Ã•ES DE VALIDAÃ‡ÃƒO
        function validarNome(input) {
            const valor = input.value.trim();
            const icon = document.getElementById('nomeIcon');
            const message = document.getElementById('nomeMessage');

            if (valor.length < 3) {
                setValidationState(input, icon, message, false, 'Nome deve ter pelo menos 3 caracteres');
                return false;
            }

            if (valor.split(' ').length < 2) {
                setValidationState(input, icon, message, false, 'Digite nome e sobrenome');
                return false;
            }

            setValidationState(input, icon, message, true, 'Nome vÃ¡lido');
            return true;
        }

        function validarTelefone(input) {
            const valor = input.value.replace(/\D/g, '');
            const icon = document.getElementById('telefoneIcon');
            const message = document.getElementById('telefoneMessage');

            if (valor.length < 10 || valor.length > 11) {
                setValidationState(input, icon, message, false, 'Telefone deve ter 10 ou 11 dÃ­gitos');
                return false;
            }

            setValidationState(input, icon, message, true, 'Telefone vÃ¡lido');
            return true;
        }

        function validarEmail(input) {
            const valor = input.value.trim();
            const icon = document.getElementById('emailIcon');
            const message = document.getElementById('emailMessage');

            const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;

            if (!emailRegex.test(valor)) {
                setValidationState(input, icon, message, false, 'E-mail invÃ¡lido');
                return false;
            }

            setValidationState(input, icon, message, true, 'E-mail vÃ¡lido');
            return true;
        }

        function validarCPF(input) {
            const valor = input.value.replace(/\D/g, '');
            const icon = document.getElementById('cpfIcon');
            const message = document.getElementById('cpfMessage');

            if (valor.length !== 11) {
                setValidationState(input, icon, message, false, 'CPF deve ter 11 dÃ­gitos');
                return false;
            }

            // Verificar se todos os dÃ­gitos sÃ£o iguais
            if (valor === valor[0].repeat(11)) {
                setValidationState(input, icon, message, false, 'CPF invÃ¡lido');
                return false;
            }

            // ValidaÃ§Ã£o do CPF
            if (!validarDigitosCPF(valor)) {
                setValidationState(input, icon, message, false, 'CPF invÃ¡lido');
                return false;
            }

            setValidationState(input, icon, message, true, 'CPF vÃ¡lido');
            return true;
        }

        function validarDigitosCPF(cpf) {
            // Primeiro dÃ­gito verificador
            let soma = 0;
            for (let i = 0; i < 9; i++) {
                soma += parseInt(cpf[i]) * (10 - i);
            }
            let resto = soma % 11;
            let dig1 = resto < 2 ? 0 : 11 - resto;

            // Segundo dÃ­gito verificador
            soma = 0;
            for (let i = 0; i < 10; i++) {
                soma += parseInt(cpf[i]) * (11 - i);
            }
            resto = soma % 11;
            let dig2 = resto < 2 ? 0 : 11 - resto;

            return parseInt(cpf[9]) === dig1 && parseInt(cpf[10]) === dig2;
        }

        function validarCEP(input) {
            const valor = input.value.replace(/\D/g, '');
            const icon = document.getElementById('cepIcon');
            const message = document.getElementById('cepMessage');

            if (valor.length !== 8) {
                setValidationState(input, icon, message, false, 'CEP deve ter 8 dÃ­gitos');
                return false;
            }

            setValidationState(input, icon, message, true, 'CEP vÃ¡lido');
            return true;
        }

        function validarNumero(input) {
            const valor = input.value.trim();
            const icon = document.getElementById('numeroIcon');
            const message = document.getElementById('numeroMessage');

            if (valor.length === 0) {
                setValidationState(input, icon, message, false, 'NÃºmero Ã© obrigatÃ³rio');
                return false;
            }

            setValidationState(input, icon, message, true, 'NÃºmero vÃ¡lido');
            return true;
        }

        function validarEstado(input) {
            const valor = input.value.trim().toUpperCase();
            const icon = document.getElementById('estadoIcon');
            const message = document.getElementById('estadoMessage');

            if (valor.length !== 2) {
                setValidationState(input, icon, message, false, 'Estado deve ter 2 letras (ex: RJ)');
                return false;
            }

            // ForÃ§a uppercase
            input.value = valor;
            setValidationState(input, icon, message, true, 'Estado vÃ¡lido');
            return true;
        }

        function validarCidade(input) {
            const valor = input.value.trim();
            const icon = document.getElementById('cidadeIcon');
            const message = document.getElementById('cidadeMessage');

            if (valor.length < 2) {
                setValidationState(input, icon, message, false, 'Nome da cidade deve ter pelo menos 2 caracteres');
                return false;
            }

            setValidationState(input, icon, message, true, 'Cidade vÃ¡lida');
            return true;
        }

        function validarBairro(input) {
            const valor = input.value.trim();
            const icon = document.getElementById('bairroIcon');
            const message = document.getElementById('bairroMessage');

            if (valor.length < 2) {
                setValidationState(input, icon, message, false, 'Nome do bairro deve ter pelo menos 2 caracteres');
                return false;
            }

            setValidationState(input, icon, message, true, 'Bairro vÃ¡lido');
            return true;
        }

        function validarRua(input) {
            const valor = input.value.trim();
            const icon = document.getElementById('ruaIcon');
            const message = document.getElementById('ruaMessage');

            if (valor.length < 3) {
                setValidationState(input, icon, message, false, 'Nome da rua deve ter pelo menos 3 caracteres');
                return false;
            }

            setValidationState(input, icon, message, true, 'Rua vÃ¡lida');
            return true;
        }

        function setValidationState(input, icon, message, isValid, text) {
            input.classList.remove('valid', 'invalid');
            icon.classList.remove('valid', 'invalid');
            message.classList.remove('success', 'error');

            if (isValid) {
                input.classList.add('valid');
                icon.classList.add('valid');
                icon.textContent = 'âœ“';
                message.classList.add('success');
                message.textContent = text;
            } else {
                input.classList.add('invalid');
                icon.classList.add('invalid');
                icon.textContent = 'âœ—';
                message.classList.add('error');
                message.textContent = text;
            }
        }

        // ðŸŒ BUSCAR CEP
        async function buscarCEP() {
            const cepInput = document.getElementById('cep');
            const cep = cepInput.value.replace(/\D/g, '');

            if (cep.length !== 8) return;

            const loading = document.getElementById('cepLoading');
            const icon = document.getElementById('cepIcon');

            try {
                loading.style.display = 'block';
                icon.style.display = 'none';

                console.log(`ðŸ” Buscando CEP: ${cep}`);

                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const data = await response.json();

                if (data.erro) {
                    throw new Error('CEP nÃ£o encontrado');
                }

                console.log('âœ… CEP encontrado:', data);

                // Preencher campos automaticamente
                document.getElementById('estado').value = data.uf || '';
                document.getElementById('cidade').value = data.localidade || '';
                document.getElementById('bairro').value = data.bairro || '';
                document.getElementById('rua').value = data.logradouro || '';

                // Validar campos preenchidos automaticamente
                ['estado', 'cidade', 'bairro', 'rua'].forEach(campo => {
                    const input = document.getElementById(campo);
                    const icon = document.getElementById(campo + 'Icon');
                    const message = document.getElementById(campo + 'Message');

                    if (input.value.trim()) {
                        setValidationState(input, icon, message, true, 'Preenchido automaticamente via CEP');
                    } else {
                        // Se nÃ£o veio do CEP, deixar para o usuÃ¡rio preencher
                        input.placeholder = `Preencha ${campo === 'rua' ? 'o nome da rua' : 'o ' + campo}`;
                        setValidationState(input, icon, message, false, `${campo.charAt(0).toUpperCase() + campo.slice(1)} nÃ£o encontrado no CEP`);
                    }
                });

                mostrarToast('CEP encontrado! Verifique os dados preenchidos.', 'success');

                // Focar no campo nÃºmero
                setTimeout(() => {
                    document.getElementById('numero').focus();
                }, 500);

            } catch (error) {
                console.error('âŒ Erro ao buscar CEP:', error);
                mostrarToast('CEP nÃ£o encontrado. Preencha os campos manualmente.', 'warning');

                // Limpar campos se houver erro
                ['estado', 'cidade', 'bairro', 'rua'].forEach(campo => {
                    const input = document.getElementById(campo);
                    if (!input.value.trim()) {
                        input.placeholder = `Digite ${campo === 'rua' ? 'o nome da rua' : 'o ' + campo}`;
                    }
                });

            } finally {
                loading.style.display = 'none';
                icon.style.display = 'block';

                // Sempre verificar se o formulÃ¡rio estÃ¡ completo
                setTimeout(verificarFormularioCompleto, 500);
            }
        }

        // âœ… VERIFICAR SE FORMULÃRIO ESTÃ COMPLETO
        function verificarFormularioCompleto() {
            const camposObrigatorios = [
                'nomeCompleto', 'telefone', 'email', 'cpf',
                'cep', 'estado', 'cidade', 'bairro', 'rua', 'numero'
            ];

            let todosValidos = true;

            camposObrigatorios.forEach(campo => {
                const input = document.getElementById(campo);
                if (!input.classList.contains('valid') || input.value.trim() === '') {
                    todosValidos = false;
                }
            });

            // Verificar se hÃ¡ itens no carrinho
            if (!dadosCheckout || !dadosCheckout.itens || dadosCheckout.itens.length === 0) {
                todosValidos = false;
            }

            formularioValido = todosValidos;
            document.getElementById('btnFinalizar').disabled = !todosValidos;

            return todosValidos;
        }

        // ðŸ“‹ CONFIGURAR FORMULÃRIO
        function configurarFormulario() {
            const form = document.getElementById('formularioCliente');

            form.addEventListener('submit', async function(e) {
                e.preventDefault();

                if (!formularioValido) {
                    mostrarToast('Por favor, preencha todos os campos obrigatÃ³rios', 'error');
                    return;
                }

                await submeterFormulario();
            });
        }

        // ðŸš€ SUBMETER FORMULÃRIO
        async function submeterFormulario() {
            try {
                mostrarLoading(true);

                // Coletar dados do formulÃ¡rio
                const dadosCliente = coletarDadosFormulario();
                console.log('ðŸ“¤ Enviando dados do cliente:', dadosCliente);
                console.log('ðŸ“¦ Enviando itens do carrinho:', dadosCheckout.itens);

                // âœ… CONEXÃƒO REAL COM A API
                const response = await fetch(`${API_BASE}/api/pedidos/criar`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        cliente: dadosCliente,
                        itens: dadosCheckout.itens
                    })
                });

                console.log('ðŸ“¡ Status da resposta:', response.status);

                // Verificar se a resposta Ã© vÃ¡lida
                if (!response.ok) {
                    const errorData = await response.text();
                    console.error('âŒ Erro HTTP:', response.status, errorData);
                    throw new Error(`Erro do servidor: ${response.status} - ${response.statusText}`);
                }

                // Processar resposta da API
                const resultado = await response.json();
                console.log('ðŸ“¨ Resposta da API:', resultado);

                if (resultado.success) {
                    // âœ… SUCESSO - Pedido criado!
                    console.log('ðŸŽ‰ Pedido criado com sucesso!');
                    console.log(`ðŸ“¦ Pedido ID: ${resultado.pedido_id}`);
                    console.log(`ðŸ‘¤ Cliente ID: ${resultado.cliente_id}`);
                    console.log(`ðŸ’° Valor Total: R$ ${resultado.valor_total?.toFixed(2) || '0,00'}`);

                    // Limpar carrinho apÃ³s sucesso
                    localStorage.removeItem('carrinho_samarone');
                    sessionStorage.removeItem('carrinho_checkout');

                    // Mostrar mensagem de sucesso
                    mostrarToast(`Pedido #${resultado.pedido_id} criado com sucesso!`, 'success');

                    // Salvar dados do pedido para pÃ¡gina de confirmaÃ§Ã£o
                    sessionStorage.setItem('pedido_confirmacao', JSON.stringify({
                        pedido_id: resultado.pedido_id,
                        cliente_id: resultado.cliente_id,
                        valor_total: resultado.valor_total,
                        cliente: dadosCliente,
                        itens: dadosCheckout.itens,
                        data_pedido: new Date().toISOString(),
                        message: resultado.message
                    }));

                    // Aguardar um pouco para mostrar o sucesso
                    setTimeout(() => {
                        // TODO: Redirecionar para pÃ¡gina de confirmaÃ§Ã£o quando estiver pronta
                        // window.location.href = 'confirmacao.html';

                        // Por enquanto, mostrar alert de sucesso
                        alert(`ðŸŽ‰ PEDIDO CRIADO COM SUCESSO!\n\n` +
                              `ðŸ“¦ NÃºmero do Pedido: #${resultado.pedido_id}\n` +
                              `ðŸ‘¤ Cliente: ${dadosCliente.nome_completo}\n` +
                              `ðŸ’° Valor Total: R$ ${(resultado.valor_total || 0).toFixed(2).replace('.', ',')}\n` +
                              `ðŸ“± Entraremos em contato via WhatsApp!`);

                        // Voltar para a landing page
                        window.location.href = '/';
                    }, 2000);

                } else {
                    // âŒ ERRO - API retornou falha
                    console.error('âŒ Erro na API:', resultado.message);
                    throw new Error(resultado.message || 'Erro desconhecido ao criar pedido');
                }

            } catch (error) {
                console.error('âŒ Erro ao submeter formulÃ¡rio:', error);

                // Mensagens de erro especÃ­ficas
                let mensagemErro = 'Erro ao processar pedido. Tente novamente.';

                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    mensagemErro = 'Erro de conexÃ£o. Verifique se o servidor estÃ¡ funcionando.';
                } else if (error.message.includes('servidor')) {
                    mensagemErro = `Erro do servidor: ${error.message}`;
                } else if (error.message) {
                    mensagemErro = error.message;
                }

                mostrarToast(mensagemErro, 'error');

                // Em caso de erro, nÃ£o limpar o formulÃ¡rio para o usuÃ¡rio tentar novamente
                console.log('ðŸ”„ Dados preservados para nova tentativa');

            } finally {
                mostrarLoading(false);
            }
        }

        function coletarDadosFormulario() {
            return {
                nome_completo: document.getElementById('nomeCompleto').value.trim(),
                telefone: document.getElementById('telefone').value.replace(/\D/g, ''),
                email: document.getElementById('email').value.trim(),
                cpf: document.getElementById('cpf').value.replace(/\D/g, ''),
                localizacao_exata: `${document.getElementById('rua').value}, ${document.getElementById('numero').value}${document.getElementById('complemento').value ? ', ' + document.getElementById('complemento').value : ''}, ${document.getElementById('bairro').value}, ${document.getElementById('cidade').value} - ${document.getElementById('estado').value}, CEP: ${document.getElementById('cep').value}`
            };
        }

        // ðŸ› ï¸ FUNÃ‡Ã•ES UTILITÃRIAS
        function mostrarLoading(mostrar) {
            const overlay = document.getElementById('loadingOverlay');
            const btnTexto = document.getElementById('btnTexto');
            const btnLoading = document.getElementById('btnLoading');

            overlay.style.display = mostrar ? 'flex' : 'none';
            btnTexto.style.display = mostrar ? 'none' : 'inline';
            btnLoading.style.display = mostrar ? 'inline' : 'none';

            document.getElementById('btnFinalizar').disabled = mostrar;
        }

        function mostrarToast(mensagem, tipo = 'success') {
            // Remover toast existente se houver
            const toastExistente = document.getElementById('toast');
            toastExistente.classList.remove('show');

            // Aguardar animaÃ§Ã£o de saÃ­da antes de mostrar novo
            setTimeout(() => {
                const toast = document.getElementById('toast');
                toast.textContent = mensagem;
                toast.className = `toast ${tipo}`;

                // ForÃ§ar reflow para garantir que a classe seja aplicada
                toast.offsetHeight;

                // Mostrar toast
                toast.classList.add('show');

                // Remover apÃ³s 4 segundos
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 4000);
            }, 100);
        }

        // ðŸ§ª FUNÃ‡ÃƒO PARA TESTAR (desenvolvimento)
        function preencherDadosDemo() {
            document.getElementById('nomeCompleto').value = 'JoÃ£o Silva Santos';
            document.getElementById('telefone').value = '(21) 99999-9999';
            document.getElementById('email').value = 'joao@email.com';
            document.getElementById('cpf').value = '123.456.789-09';
            document.getElementById('cep').value = '22070-900';

            // Simular busca de CEP
            setTimeout(() => {
                document.getElementById('estado').value = 'RJ';
                document.getElementById('cidade').value = 'Rio de Janeiro';
                document.getElementById('bairro').value = 'Copacabana';
                document.getElementById('rua').value = 'Avenida AtlÃ¢ntica';
                document.getElementById('numero').value = '123';

                // Validar todos os campos
                ['nomeCompleto', 'telefone', 'email', 'cpf', 'cep', 'numero'].forEach(campo => {
                    const input = document.getElementById(campo);
                    input.dispatchEvent(new Event('blur'));
                });

                mostrarToast('Dados demo preenchidos!', 'success');
            }, 1000);
        }

        // Disponibilizar funÃ§Ã£o de teste
        window.preencherDadosDemo = preencherDadosDemo;

        console.log('ðŸ“‹ FormulÃ¡rio inicializado! Use preencherDadosDemo() para testar.');
    </script>
</body>
</html>
